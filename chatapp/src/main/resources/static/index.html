<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h2>Spring Boot WebSocket Chat</h2>
    <input type="text" id="sender" placeholder="Your name" />
    <input type="text" id="message" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>

    <ul id="chat"></ul>

    <script>
        let stompClient = null;
		async function loadHistory() {
		    const response = await fetch("/history");
		    const history = await response.json();
		    history.forEach(m => {
		        document.getElementById('chat').innerHTML += `<li><b>${m.sender}</b> [${m.time}]: ${m.content}</li>`;
		    });
		}

		async function connect() {
		    await loadHistory(); // load previous messages first

		    const socket = new SockJS('/ws');
		    stompClient = Stomp.over(socket);
		    stompClient.connect({}, () => {
		        stompClient.subscribe('/topic/messages', (msg) => {
		            const m = JSON.parse(msg.body);
		            document.getElementById('chat').innerHTML += `<li><b>${m.sender}</b> [${m.time}]: ${m.content}</li>`;
		        });
		    });
		}

        function sendMessage() {
            const sender = document.getElementById('sender').value;
            const content = document.getElementById('message').value;
            stompClient.send("/app/chat", {}, JSON.stringify({ sender, content }));
        }

        connect();
    </script>
</body>
</html>
